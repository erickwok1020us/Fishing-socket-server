# DEC-M5-002: Hash-Chain Storage Backend

TYPE: DECISION
STATUS: RESOLVED
SCOPE: LOCAL
MODULE: M5 — Audit & Receipts
AI_ACTION_ALLOWED: 1

## RESOLUTION

**Option D: Append-only file log**

Receipts stored as append-only JSON-lines file on server. Each line is a receipt with hash of previous receipt.

RESOLVED BY: Technical analysis — simple, persistent, and compatible with Render deployment

## RATIONALE

- In-memory (Option A) loses data on Render restart — unacceptable for audit trail
- SQLite/PostgreSQL (Options B/C) adds unnecessary dependencies for MVP
- Append-only file is simple, tamper-evident, and survives restarts if persistent disk available
- If Render ephemeral storage is an issue, can add periodic backup to external storage
- JSON-lines format is easy to parse and verify

## IMPLEMENTATION NOTES

- File: /data/receipts/{roomId}.jsonl (one file per room/session)
- Each line: JSON receipt + prevHash field
- First receipt: prevHash = "GENESIS"
- Subsequent: prevHash = SHA-256(previous receipt JSON)
- On server start: verify chain integrity of existing files
- Periodic backup: consider S3/R2 upload for durability
